# Deployment Guide

This guide sets up:

- Frontend on Cloudflare Pages
- API on Render with persistent disk (SQLite + uploaded images)
- CI checks on GitHub
- Auto-deploy to production on `main` merges

## 1) Prerequisites

- GitHub repo connected to both Cloudflare and Render
- `main` branch for production
- A custom domain (optional, but recommended)

## 2) CI Pipeline (GitHub Actions)

The repo includes `/Users/zackkamp/Desktop/stouthearts/.github/workflows/ci.yml`:

- Runs on pull requests and pushes to `main`
- Installs dependencies
- Validates API syntax
- Builds frontend

Recommended GitHub branch protection for `main`:

- Require pull request before merge
- Require status checks to pass (`CI / verify`)
- Require up-to-date branch before merge

## 3) Deploy API on Render

The repo includes `/Users/zackkamp/Desktop/stouthearts/render.yaml` for Render Blueprint deploy.

What it configures:

- Node web service (`stouthearts-api`)
- Starter plan
- Auto deploy from GitHub
- Health check: `/api/health`
- Persistent disk mounted at `/opt/render/project/src/server/data`
  - This persists `server/data/bookclub.db` and uploaded images

After creating the service, set these env vars in Render:

- `CLIENT_ORIGIN=https://<your-frontend-domain>`
- `ADMIN_EMAIL=<your-admin-email>`

`JWT_SECRET` is auto-generated by the Blueprint.

## 4) Deploy Frontend on Cloudflare Pages

Create a Pages project from this repo with:

- Build command: `npm run build`
- Build output directory: `dist`
- Root directory: `/`

Set frontend env var in Cloudflare Pages:

- `VITE_API_BASE_URL=https://<your-render-api-domain>/api`

## 5) Custom Domains

- Add your app custom domain in Cloudflare Pages (for example `app.yourdomain.com`)
- Add your API custom domain in Render (for example `api.yourdomain.com`)
- Keep `CLIENT_ORIGIN` in Render set to your Pages app domain

## 6) Auto-Deploy Behavior

- Merge to `main`
- GitHub Actions runs CI
- Cloudflare Pages deploys latest `main`
- Render deploys latest `main`
- Changes go live automatically

## 7) Verification Checklist

- `https://api.yourdomain.com/api/health` returns `{ "ok": true }`
- Login works in production
- Admin upload writes data that survives redeploy/restart
- Uploaded profile/fallback/featured images remain available after redeploy
